package app.cash.trifle.internal

import app.cash.trifle.protos.api.alpha.SignedData
import com.google.common.annotations.VisibleForTesting
import org.bouncycastle.asn1.ASN1ObjectIdentifier
import org.bouncycastle.asn1.x509.AlgorithmIdentifier

sealed class TrifleAlgorithmIdentifier(
  oid: String,
  params: ASN1ObjectIdentifier? = null
) : AlgorithmIdentifier(ASN1ObjectIdentifier(oid), params) {
  // Registry http://oid-info.com/cgi-bin/display?oid=1.2.840.10040.4.3&a=display
  @VisibleForTesting
  object DSAAlgorithmIdentifier: TrifleAlgorithmIdentifier("1.2.840.10040.4.3")

  // Defined in https://www.rfc-editor.org/rfc/rfc8420
  // Registry http://oid-info.com/cgi-bin/display?oid=1.3.101.112&a=display
  object EdDSAAlgorithmIdentifier: TrifleAlgorithmIdentifier(oid = "1.3.101.112")

  // Defined in https://www.rfc-editor.org/rfc/rfc5758
  // Registry http://oid-info.com/cgi-bin/display?oid=1.2.840.10045.4.3.2&a=display
  object ECDSASha256AlgorithmIdentifier: TrifleAlgorithmIdentifier(oid = "1.2.840.10045.4.3.2")

  // Defined in https://datatracker.ietf.org/doc/html/draft-josefsson-pkix-newcurves-01
  // Registry http://oid-info.com/cgi-bin/display?oid=1.3.6.1.4.1.11591.15.1&a=display
  object Ed25519AlgorithmIdentifier: TrifleAlgorithmIdentifier(oid = "1.3.6.1.4.1.11591.15.1")

  // Defined in https://www.rfc-editor.org/rfc/rfc5480
  // Registry http://oid-info.com/cgi-bin/display?oid=1.2.840.10045.3.1.7&a=display
  object P256v1AlgorithmIdentifier: TrifleAlgorithmIdentifier(oid = "1.2.840.10045.3.1.7")

  // Defined in https://www.rfc-editor.org/rfc/rfc3279
  // Registry http://oid-info.com/cgi-bin/display?oid=1.2.840.10045.2.1&a=display
  class ECPublicKeyAlgorithmIdentifier(curve: TrifleAlgorithmIdentifier)
    : TrifleAlgorithmIdentifier(oid = "1.2.840.10045.2.1", params = curve.algorithm)

  fun encode(): SignedData.Algorithm =
    when (this) {
      is ECDSASha256AlgorithmIdentifier -> SignedData.Algorithm.ECDSA_SHA256
      else -> {
        throw Exception("Unsupported signing algorithm encoding")
      }
    }

  internal companion object {
    fun decode(signingAlgorithm: SignedData.Algorithm): TrifleAlgorithmIdentifier =
      when (signingAlgorithm) {
        SignedData.Algorithm.ECDSA_SHA256 -> ECDSASha256AlgorithmIdentifier
        else -> {
          throw Exception("Unsupported signing algorithm decoding")
        }
      }
  }
}
